<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç²‰ä¸æµ‹è¯• - ä½ å¥½å—</title>
    <link rel="stylesheet" href="style.css">
    <link href="https://cdn.bootcdn.net/ajax/libs/twitter-bootstrap/5.3.0/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        .question-card {
            background: white;
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
            margin-bottom: 25px;
        }
        
        .option-item {
            padding: 15px;
            margin: 10px 0;
            border: 2px solid #e9ecef;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .option-item:hover {
            border-color: #4361ee;
            background-color: rgba(67, 97, 238, 0.05);
        }
        
        .option-item.selected {
            border-color: #4361ee;
            background-color: rgba(67, 97, 238, 0.1);
        }
        
        .timer {
            font-size: 1.5rem;
            font-weight: bold;
            color: #4361ee;
        }
        
        .result-card {
            text-align: center;
            padding: 40px;
            background: linear-gradient(135deg, #f8f9fa, #e9ecef);
            border-radius: 15px;
            box-shadow: 0 15px 40px rgba(0, 0, 0, 0.1);
        }
        
        .score-display {
            font-size: 4rem;
            font-weight: 800;
            background: linear-gradient(135deg, #4361ee, #f72585);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin: 20px 0;
        }
        @media (max-width: 768px) {
    .option-item { padding: 16px 12px; min-height: 50px; }
    .score-display { font-size: 2.5rem; }
    .timer { font-size: 1.2rem; }
    .question-card { padding: 16px; }
}
    </style>
</head>
<body>
    <!-- å¯¼èˆªæ  -->
    <nav class="navbar navbar-expand-lg navbar-dark bg-primary fixed-top">
        <div class="container">
            <a class="navbar-brand" href="index.html">
                <i class="fas fa-film me-2"></i>ä½ å¥½å—
            </a>
            <a class="nav-link text-white" href="index.html">
                <i class="fas fa-home me-1"></i>è¿”å›é¦–é¡µ
            </a>
        </div>
    </nav>

    <!-- ä¸»è¦å†…å®¹ -->
    <div class="container mt-5 pt-4">
  <!-- è€ƒè¯•è¯´æ˜ -->
<div id="examInstructions" class="card mb-4">
    <div class="card-body">
        <h4 class="card-title"><i class="fas fa-info-circle me-2"></i>è€ƒè¯•è¯´æ˜</h4>
        <ul class="mb-0">
            <li>æœ¬æ¬¡è€ƒè¯•ä» <span class="fw-bold">æ¨¡æ‹Ÿè€ƒè¯•é¢˜åº“</span> éšæœºæŠ½å–é¢˜ç›®</li>
            <li>æ¯é¢˜ <span class="fw-bold">20</span> åˆ†ï¼Œæ€»åˆ† 100 åˆ†</li>
            <li>è€ƒè¯•æ—¶é—´ <span class="fw-bold">10</span> åˆ†é’Ÿ</li>
            <li>å¾—åˆ†è¶Šé«˜ï¼ŒæŠ¢ç¥¨æ—¶äº«å—çš„ä¼˜æƒ è¶Šå¤§</li>
            <li><span class="text-success">å…¨å¯¹ï¼ˆ100åˆ†ï¼‰</span> â†’ ç²‰ä¸ä¼˜æƒ ä»· 9.9å…ƒ</li>
            <li><span class="text-info">é«˜åˆ†ï¼ˆ80-99åˆ†ï¼‰</span> â†’ ç²‰ä¸ä»· 19.9å…ƒ</li>
            <li><span class="text-warning">åŠæ ¼ï¼ˆ60-79åˆ†ï¼‰</span> â†’ æ ‡å‡†ä»· 29.9å…ƒ</li>
            <li><span class="text-danger">ä¸åŠæ ¼ï¼ˆ<60åˆ†ï¼‰</span> â†’ åŸä»· 49.9å…ƒ</li>
        </ul>
        <div class="text-center mt-3">
            <button class="btn btn-primary btn-lg" id="startExamBtn">
                <i class="fas fa-play me-2"></i>å¼€å§‹è€ƒè¯•
            </button>
        </div>
    </div>
</div>

        <!-- è€ƒè¯•çŠ¶æ€æ  -->
        <div id="examStatusBar" class="mb-4" style="display: none;">
            <div class="row align-items-center">
                <div class="col-md-6">
                    <div class="timer" id="timer">10:00</div>
                </div>
                <div class="col-md-6 text-end">
                    <h5 id="questionCounter">ç¬¬ 1/5 é¢˜</h5>
                </div>
            </div>
        </div>

        <!-- è€ƒè¯•å†…å®¹ -->
        <div id="examContent" style="display: none;">
            <!-- é¢˜ç›®ä¼šåŠ¨æ€ç”Ÿæˆ -->
        </div>

        <!-- è€ƒè¯•å¯¼èˆª -->
        <div id="examNavigation" class="mt-4" style="display: none;">
            <div class="row">
                <div class="col-md-6">
                    <button class="btn btn-outline-primary w-100" id="prevQuestionBtn" disabled>
                        <i class="fas fa-arrow-left me-2"></i>ä¸Šä¸€é¢˜
                    </button>
                </div>
                <div class="col-md-6">
                    <button class="btn btn-primary w-100" id="nextQuestionBtn">
                        ä¸‹ä¸€é¢˜ <i class="fas fa-arrow-right ms-2"></i>
                    </button>
                </div>
            </div>
            <div class="text-center mt-3">
                <button class="btn btn-success btn-lg" id="finishExamBtn" style="display: none;">
                    <i class="fas fa-check-circle me-2"></i>å®Œæˆç­”é¢˜ï¼ŒæŸ¥çœ‹æˆç»©
                </button>
            </div>
        </div>
      
        <!-- è€ƒè¯•ç»“æœ -->
        <div id="examResult" class="result-card" style="display: none;">
            <div id="resultContent">
                <!-- ç»“æœä¼šåŠ¨æ€ç”Ÿæˆ -->
            </div>
        </div>
    </div>

   

    <!-- è„šæœ¬ -->
    <!-- å…ˆåŠ è½½api.js -->
    <script src="api.js"></script>
    <!-- å†åŠ è½½bootstrap -->
    <script src="https://cdn.bootcdn.net/ajax/libs/bootstrap/5.3.0/js/bootstrap.bundle.min.js"></script>
    
    <script>
        // ==================== è€ƒè¯•é¡µé¢è„šæœ¬ ====================
         // æ£€æŸ¥APIæ˜¯å¦åŠ è½½çš„å‡½æ•°
        function checkAPI() {
            if (typeof API === 'undefined') {
                console.error('âŒ APIæœªå®šä¹‰');
                alert('ç³»ç»Ÿåˆå§‹åŒ–å¤±è´¥ï¼Œè¯·åˆ·æ–°é¡µé¢é‡è¯•');
                return false;
            }
            return true;
        }
        // è€ƒè¯•çŠ¶æ€
        let examState = {
            questions: [],
            currentIndex: 0,
            userAnswers: [],
            timeLeft: 1800, // 10åˆ†é’Ÿ
            timer: null,
            isCompleted: false,
            score: 0
        };

        // é¡µé¢åŠ è½½
        document.addEventListener('DOMContentLoaded', function() {
            console.log('âœ… è€ƒè¯•é¡µé¢åŠ è½½å®Œæˆ');
            
            // ç»‘å®šæŒ‰é’®äº‹ä»¶
            document.getElementById('startExamBtn').addEventListener('click', startExam);
            document.getElementById('prevQuestionBtn').addEventListener('click', prevQuestion);
            document.getElementById('nextQuestionBtn').addEventListener('click', nextQuestion);
            document.getElementById('finishExamBtn').addEventListener('click', finishExam);
        });

       // å¼€å§‹è€ƒè¯•
async function startExam() {
    console.log('å¼€å§‹è€ƒè¯•');
    // å†æ¬¡æ£€æŸ¥API
    if (!checkAPI()) return;
    try {
        // 1. ä»APIè·å–é¢˜ç›® - ä¿®æ”¹è¿™è¡Œ
        const result = await API.getExamQuestions('simulate', 15);  // âœ… ä½¿ç”¨æ–°æ–¹æ³•
        
        if (result.success && result.data.questions.length > 0) {
            examState.questions = result.data.questions;
            examState.userAnswers = new Array(examState.questions.length).fill(null);
            
            // 2. éšè—è¯´æ˜ï¼Œæ˜¾ç¤ºè€ƒè¯•ç•Œé¢
            document.getElementById('examInstructions').style.display = 'none';
            document.getElementById('examStatusBar').style.display = 'block';
            document.getElementById('examContent').style.display = 'block';
            document.getElementById('examNavigation').style.display = 'block';
            
            // 3. å¼€å§‹è®¡æ—¶å™¨
            startTimer();
            
            // 4. æ˜¾ç¤ºç¬¬ä¸€é¢˜
            showQuestion(0);
            
        } else {
            // æ˜¾ç¤ºæ›´å…·ä½“çš„é”™è¯¯ä¿¡æ¯
            alert(`æ— æ³•åŠ è½½é¢˜ç›®: ${result.message || 'æœªçŸ¥é”™è¯¯'}ï¼Œè¯·æ£€æŸ¥ data/questions.json æ–‡ä»¶`);
            console.error('åŠ è½½é¢˜ç›®å¤±è´¥:', result);
        }
    } catch (error) {
        console.error('å¼€å§‹è€ƒè¯•å¤±è´¥:', error);
        alert('è€ƒè¯•ç³»ç»Ÿå‡ºç°é”™è¯¯ï¼Œè¯·ç¨åé‡è¯•');
    }
}

        // å¼€å§‹è®¡æ—¶å™¨
        function startTimer() {
            clearInterval(examState.timer);
            
            examState.timer = setInterval(() => {
                examState.timeLeft--;
                updateTimerDisplay();
                
                if (examState.timeLeft <= 0) {
                    clearInterval(examState.timer);
                    finishExam(); // æ—¶é—´åˆ°è‡ªåŠ¨äº¤å·
                }
            }, 1000);
        }

        // æ›´æ–°è®¡æ—¶å™¨æ˜¾ç¤º
        function updateTimerDisplay() {
            const minutes = Math.floor(examState.timeLeft / 60);
            const seconds = examState.timeLeft % 60;
            document.getElementById('timer').textContent = 
                `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
            
            // æ—¶é—´å°‘äº1åˆ†é’Ÿæ—¶å˜çº¢è‰²
            if (examState.timeLeft < 60) {
                document.getElementById('timer').className = 'timer text-danger';
            }
        }

        // æ˜¾ç¤ºé¢˜ç›®
        function showQuestion(index) {
            if (index < 0 || index >= examState.questions.length) return;
            
            examState.currentIndex = index;
            const question = examState.questions[index];
            
            // æ›´æ–°é¢˜ç›®è®¡æ•°å™¨
            document.getElementById('questionCounter').textContent = 
                `ç¬¬ ${index + 1}/${examState.questions.length} é¢˜`;
            
            // ç”Ÿæˆé¢˜ç›®HTML
            const questionHTML = `
                <div class="question-card">
                    <h4 class="mb-4">${index + 1}. ${question.question}</h4>
                    
                    <div class="options-list">
                        ${question.options.map((option, optionIndex) => {
                            const isSelected = examState.userAnswers[index] === optionIndex;
                            return `
                                <div class="option-item ${isSelected ? 'selected' : ''}" 
                                     onclick="selectOption(${index}, ${optionIndex})">
                                    <div class="form-check">
                                        <input class="form-check-input" type="radio" 
                                               name="question_${index}" 
                                               ${isSelected ? 'checked' : ''}>
                                        <label class="form-check-label w-100">
                                            ${String.fromCharCode(65 + optionIndex)}. ${option}
                                        </label>
                                    </div>
                                </div>
                            `;
                        }).join('')}
                    </div>
                </div>
            `;
            
            document.getElementById('examContent').innerHTML = questionHTML;
            
            // æ›´æ–°å¯¼èˆªæŒ‰é’®çŠ¶æ€
            updateNavigationButtons();
            
            // æ£€æŸ¥æ˜¯å¦å¯ä»¥æ˜¾ç¤ºå®ŒæˆæŒ‰é’®
            checkIfCanFinish();
        }

        // é€‰æ‹©é€‰é¡¹ï¼ˆå…¨å±€å‡½æ•°ï¼‰
        window.selectOption = function(questionIndex, optionIndex) {
            examState.userAnswers[questionIndex] = optionIndex;
            showQuestion(questionIndex);
        };

        // æ›´æ–°å¯¼èˆªæŒ‰é’®çŠ¶æ€
        function updateNavigationButtons() {
            const prevBtn = document.getElementById('prevQuestionBtn');
            const nextBtn = document.getElementById('nextQuestionBtn');
            
            prevBtn.disabled = examState.currentIndex === 0;
            nextBtn.disabled = examState.currentIndex === examState.questions.length - 1;
            
            // å¦‚æœæ˜¯æœ€åä¸€é¢˜ï¼Œä¿®æ”¹æŒ‰é’®æ–‡å­—
            if (examState.currentIndex === examState.questions.length - 1) {
                nextBtn.innerHTML = 'æœ€åä¸€é¢˜';
                nextBtn.disabled = true;
            } else {
                nextBtn.innerHTML = 'ä¸‹ä¸€é¢˜ <i class="fas fa-arrow-right ms-2"></i>';
            }
        }

        // ä¸Šä¸€é¢˜
        function prevQuestion() {
            if (examState.currentIndex > 0) {
                showQuestion(examState.currentIndex - 1);
            }
        }

        // ä¸‹ä¸€é¢˜
        function nextQuestion() {
            if (examState.currentIndex < examState.questions.length - 1) {
                showQuestion(examState.currentIndex + 1);
            }
        }

        // æ£€æŸ¥æ˜¯å¦å¯ä»¥å®Œæˆç­”é¢˜
        function checkIfCanFinish() {
            const allAnswered = examState.userAnswers.every(answer => answer !== null);
            if (allAnswered) {
                document.getElementById('finishExamBtn').style.display = 'block';
            }
        }

       // å®Œæˆç­”é¢˜
async function finishExam() {
    // åœæ­¢è®¡æ—¶å™¨
    clearInterval(examState.timer);
    
    // æ£€æŸ¥æœªä½œç­”çš„é¢˜ç›®
    const unansweredQuestions = examState.userAnswers
        .map((answer, index) => answer === null ? index + 1 : null)
        .filter(index => index !== null);
    
    if (unansweredQuestions.length > 0) {
        if (!confirm(`è¿˜æœ‰ ${unansweredQuestions.length} é¢˜æœªä½œç­”ï¼Œç¡®å®šè¦äº¤å·å—ï¼Ÿ`)) {
            startTimer(); // é‡æ–°å¼€å§‹è®¡æ—¶
            return;
        }
    }
    
    // è®¡ç®—åˆ†æ•°
    examState.score = calculateScore();
    examState.isCompleted = true;
    
    try {
        // æäº¤ç­”æ¡ˆåˆ°API - ä¿®æ”¹è¿™è¡Œ
        const submitData = examState.userAnswers.map((answer, index) => ({
            questionId: examState.questions[index].id,
            userAnswer: answer
        }));
        
        const result = await API.submitExam('simulate', submitData);  // âœ… ä½¿ç”¨æ–°æ–¹æ³•
        
        if (result.success) {
            showExamResult(result.data);
        } else {
            // ä½¿ç”¨æœ¬åœ°è®¡ç®—çš„åˆ†æ•°
            showExamResult({
                score: examState.score,
                correctCount: getCorrectCount(examState.score, examState.questions.length),
                totalQuestions: examState.questions.length,
                price: getPriceByScore(examState.score),
                message: 'è€ƒè¯•å®Œæˆï¼'
            });
        }
    } catch (error) {
        console.error('æäº¤å¤±è´¥:', error);
        showExamResult({
            score: examState.score,
            correctCount: getCorrectCount(examState.score, examState.questions.length),
            totalQuestions: examState.questions.length,
            price: getPriceByScore(examState.score),
            message: 'è€ƒè¯•å®Œæˆï¼'
        });
    }
}

// æ·»åŠ è¾…åŠ©å‡½æ•°ï¼šæ ¹æ®åˆ†æ•°è®¡ç®—ç­”å¯¹é¢˜æ•°
function getCorrectCount(score, totalQuestions) {
    return Math.round((score / 100) * totalQuestions);
}

        // è®¡ç®—åˆ†æ•°
        function calculateScore() {
            let correctCount = 0;
            
            examState.questions.forEach((question, index) => {
                const userAnswer = examState.userAnswers[index];
                if (userAnswer !== null && userAnswer === question.correctAnswer) {
                    correctCount++;
                }
            });
            
            return Math.round((correctCount / examState.questions.length) * 100);
        }

        // æ ¹æ®åˆ†æ•°è·å–ä»·æ ¼
        function getPriceByScore(score) {
            if (score >= 95) return 9.9;
            if (score >= 80) return 19.9;
            if (score >= 60) return 29.9;
            return 49.9;
        }

        // æ˜¾ç¤ºè€ƒè¯•ç»“æœ
        function showExamResult(resultData) {
            console.log('æ˜¾ç¤ºè€ƒè¯•ç»“æœ:', resultData);
            
            // éšè—è€ƒè¯•ç•Œé¢
            document.getElementById('examStatusBar').style.display = 'none';
            document.getElementById('examContent').style.display = 'none';
            document.getElementById('examNavigation').style.display = 'none';
            
            // ç”Ÿæˆç»“æœHTML
            const resultHTML = `
                <div class="mb-4">
                    <i class="fas fa-trophy fa-4x text-warning"></i>
                    <h2 class="mt-3">ğŸ‰ è€ƒè¯•å®Œæˆï¼</h2>
                </div>
                
                <div class="score-display">${resultData.score}åˆ†</div>
                
                <div class="mb-4">
                    <p>ç­”å¯¹ <span class="fw-bold">${resultData.correctCount}</span> é¢˜ / å…± ${resultData.totalQuestions} é¢˜</p>
                    <p>æ­£ç¡®ç‡ï¼š<span class="fw-bold">${Math.round((resultData.correctCount / resultData.totalQuestions) * 100)}%</span></p>
                </div>
                
                <div class="mb-4">
                    <h5>ä½ çš„æŠ¢ç¥¨ä¼˜æƒ ï¼š</h5>
                    <div class="h2 text-success">${resultData.price.toFixed(1)} å…ƒ</div>
                    <p class="mt-2">${getPriceMessage(resultData.score)}</p>
                </div>
                
                <div class="mt-4">
                    <button class="btn btn-primary btn-lg me-3" onclick="goToTicket(${resultData.score})">
                        <i class="fas fa-ticket-alt me-2"></i>å‰å¾€æŠ¢ç¥¨
                    </button>
                    <button class="btn btn-outline-secondary btn-lg" onclick="location.reload()">
                        <i class="fas fa-redo me-2"></i>é‡æ–°è€ƒè¯•
                    </button>
                </div>
            `;
            
            document.getElementById('resultContent').innerHTML = resultHTML;
            document.getElementById('examResult').style.display = 'block';
        }

        // è·å–ä»·æ ¼æç¤ºæ¶ˆæ¯
        function getPriceMessage(score) {
            if (score >= 95) return 'ğŸ‰ æ­å–œå…¨å¯¹ï¼è·å¾—ç²‰ä¸ä¸“å±ä¼˜æƒ ä»·';
            if (score >= 80) return 'ğŸ‘ ä¼˜ç§€ï¼è·å¾—ç²‰ä¸ä¼˜æƒ ä»·';
            if (score >= 60) return 'ğŸ‘ ä¸é”™ï¼è·å¾—æ ‡å‡†ç¥¨ä»·';
            return 'ğŸ’ª ç»§ç»­åŠªåŠ›ï¼Œå¤šçœ‹å¤šå­¦ç”µå½±çŸ¥è¯†';
        }

        // è·³è½¬åˆ°æŠ¢ç¥¨é¡µ
        window.goToTicket = function(score) {
            window.location.href = `ticket.html?mode=exam&score=${score}`;
        };
    </script>
</body>
</html>